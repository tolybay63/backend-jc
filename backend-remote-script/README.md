# Удаленное развертывание Backend-сервисов DTJ

## Обзор

Скрипты для автоматического развертывания Java backend-сервисов между серверами в домене EFK.

## Архитектура серверов

### Dev Server (scl-007.efk.local)
- **IP**: 192.168.1.215
- **ОС**: Windows 10 Корпоративная LTSC
- **Корневая папка**: `C:\jc-2\backend-jc`
- **Назначение**: Разработка и сборка сервисов

### Prod Server (swl-001.efk.local)
- **IP**: 192.168.1.20
- **ОС**: Windows Server 2019 Standard
- **Корневая папка**: `C:\dtj\server`
- **Назначение**: Продакшн развертывание

## Backend-сервисы

| Сервис | Dev Path | Prod Path | Порт |
|--------|----------|-----------|------|
| admin | tofi-adm | admin | 9172 |
| nsi | dtj\dtj-nsi | nsi | 9173 |
| orgstructure | dtj\dtj-orgstructure | orgstructure | 9174 |
| personnel | dtj\dtj-personnel | personnel | 9175 |
| reports | dtj\dtj-reports | reports | 9176 |
| settings | dtj\dtj-settings | settings | 9177 |
| tasks | dtj\dtj-tasks | tasks | 9178 |
| workflow | dtj\dtj-workflow | workflow | 9179 |
| documents | dtj\dtj-documents | documents | 9180 |
| calendar | dtj\dtj-calendar | calendar | 9181 |
| dashboard | dtj\dtj-dashboard | dashboard | 9182 |

## Методы развертывания

### 1. SMB (рекомендуется)
- Использует сетевые пути Windows
- Требует доступ к общим папкам
- Быстрое копирование файлов

### 2. PowerShell Remoting
- Использует WinRM
- Требует настройки WinRM на серверах
- Более безопасный метод

## Настройка

### 1. Конфигурация
Отредактируйте `backend-remote-config.json`:
- Укажите правильные учетные данные
- Проверьте пути к сервисам
- Выберите метод развертывания

### 2. Учетные данные
```json
"Credentials": {
  "Username": "efk\\username",
  "Password": "password"
}
```

### 3. Сетевая доступность
Убедитесь что:
- Dev и Prod серверы доступны по сети
- Порты для SMB (445) или WinRM (5985) открыты
- Учетные данные имеют необходимые права

## Использование

### Через batch файл
```cmd
deploy-backend-remote.bat
```

### Через PowerShell
```powershell
# Полное развертывание всех сервисов
.\deploy-backend-remote.ps1 -Action full

# Только сборка
.\deploy-backend-remote.ps1 -Action build

# Только деплой
.\deploy-backend-remote.ps1 -Action deploy

# Запуск сервисов
.\deploy-backend-remote.ps1 -Action start

# Остановка сервисов
.\deploy-backend-remote.ps1 -Action stop

# Очистка папок
.\deploy-backend-remote.ps1 -Action clear

# Выборочное развертывание
.\deploy-backend-remote.ps1 -Action full -ServiceNames admin,nsi,reports
```

## Процесс развертывания

### Полное развертывание (full)
1. **Сборка** - выполняется `jc.bat product` в папке каждого сервиса
2. **Остановка** - останавливаются процессы на указанных портах
3. **Очистка** - удаляются старые файлы из папки назначения
4. **Копирование** - копируются новые файлы из `build` папки
5. **Запуск** - выполняется `app-run.bat` для запуска сервиса

### Отдельные операции
- **build** - только сборка сервисов
- **deploy** - только копирование файлов
- **start** - запуск сервисов
- **stop** - остановка сервисов
- **clear** - очистка папок назначения

## Безопасность

### Рекомендации
- Используйте отдельные учетные записи для развертывания
- Ограничьте права доступа к папкам сервисов
- Регулярно меняйте пароли
- Логируйте все операции развертывания

### Сетевая безопасность
- Используйте VPN для удаленного доступа
- Настройте файрвол для ограничения доступа
- Мониторьте сетевой трафик

## Устранение неполадок

### Ошибки подключения
```
[ERROR] Не удается подключиться к серверу
```
**Решение**: Проверьте сетевую доступность и учетные данные

### Ошибки сборки
```
[ERROR] Ошибка при сборке сервиса
```
**Решение**: Проверьте наличие Java 17 и Gradle в PATH

### Ошибки копирования
```
[ERROR] Ошибка при копировании файлов
```
**Решение**: Проверьте права доступа к папкам назначения

### Ошибки запуска
```
[ERROR] Ошибка при запуске сервиса
```
**Решение**: Проверьте занятость портов и конфигурацию сервиса

## Логирование

Все операции логируются с временными метками:
```
[2024-01-15 14:30:30] [INFO] Сборка сервиса admin завершена успешно
[2024-01-15 14:30:35] [ERROR] Ошибка при копировании nsi
```

## Требования

### На Dev сервере
- Java 17 JDK
- Gradle
- Jandcode Framework (jc.bat)
- PowerShell 7+

### На Prod сервере
- Java 17 JRE
- PowerShell 7+
- Доступ к сетевым папкам (для SMB)
- Настроенный WinRM (для PowerShell Remoting)
